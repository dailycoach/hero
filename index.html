<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>COACHERO 크루원 | 일일 기록 (KOUM 4단계) — Earth Palette</title>

  <style>
    /* =========================================================
       COACHERO Daily Log (Single HTML) — Earth Palette Edition
       Reference palette (photo):
       #7F8E8B  (slate-sage)
       #AEAFA1  (sage-gray)
       #FCCE92  (sunset sand)
       #584A1B  (deep olive)
       #684E2D  (warm brown)
       #C39C73  (tan)
       - Kakao share + text copy 중심
       - 모바일 작성 UX 최적화(하단 액션바)
    ========================================================= */

    :root{
      /* Photo palette */
      --p-slate: #7F8E8B;
      --p-sage:  #AEAFA1;
      --p-sand:  #FCCE92;
      --p-olive: #584A1B;
      --p-brown: #684E2D;
      --p-tan:   #C39C73;

      /* Dark (earth) base */
      --bg:   #0e0f0c;
      --card: #151610;
      --card2:#11120d;
      --text: #f4efe6;
      --muted:#c6c0b4;
      --line: rgba(174,175,161,.22);

      /* Brand mapping */
      --brand:  var(--p-sand);  /* 주요 강조(따뜻한 모래빛) */
      --brand2: var(--p-tan);   /* 보조 강조(탄) */
      --accent: var(--p-slate); /* 차분한 청록/회녹 */
      --accent2:var(--p-sage);

      /* Effects */
      --shadow: 0 10px 28px rgba(0,0,0,.42);
      --radius: 16px;
      --focus: 0 0 0 3px rgba(252,206,146,.28);

      /* Typography */
      --fs-base: 14px;
      --fs-input: 14px;
    }

    [data-theme="light"]{
      --bg:   #fbf8f2;
      --card: #ffffff;
      --card2:#ffffff;
      --text: #221c12;
      --muted:#5c5549;
      --line: rgba(104,78,45,.18);
      --shadow: 0 10px 26px rgba(34,28,18,.10);
      --focus: 0 0 0 3px rgba(104,78,45,.16);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    html{ -webkit-text-size-adjust: 100%; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      color: var(--text);
      font-size: var(--fs-base);
      line-height: 1.65;

      /* Earth ambience (no external image) */
      background:
        radial-gradient(1100px 700px at 20% 0%, rgba(127,142,139,.20), transparent 60%),
        radial-gradient(1000px 650px at 95% 10%, rgba(195,156,115,.16), transparent 55%),
        radial-gradient(900px 520px at 55% 110%, rgba(252,206,146,.10), transparent 58%),
        radial-gradient(900px 520px at 5% 90%, rgba(88,74,27,.10), transparent 60%),
        linear-gradient(180deg, rgba(174,175,161,.06), transparent 26%),
        var(--bg);
    }

    a{ color: var(--brand); text-decoration:none; }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 16px 70px;
    }

    /* ---------- Top / Header ---------- */
    .top{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom: 12px;
    }
    .brandBlock{ display:flex; flex-direction:column; gap:6px; }
    .brandBlock h1{
      margin:0;
      font-size: 20px;
      letter-spacing: -.3px;
    }
    .subtitle{
      color: var(--muted);
      font-size: 13px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(17,18,13,.55);
      box-shadow: var(--shadow);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    [data-theme="light"] .badge{ background: rgba(255,255,255,.78); }
    .badge b{ color: var(--text); font-weight: 800; }
    .tiny{ font-size: 11px; color: var(--muted); }

    /* ---------- Buttons ---------- */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(21,22,16,.70);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      box-shadow: var(--shadow);
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: .15s transform ease, .15s opacity ease, .15s background ease;
      user-select:none;
      min-height: 44px;
      touch-action: manipulation;
    }
    [data-theme="light"] .btn{ background: rgba(255,255,255,.88); }

    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); opacity: .93; }
    .btn.ghost{ background: transparent; box-shadow:none; }
    .btn.small{ padding: 8px 10px; border-radius: 12px; font-size: 12px; min-height: 38px; }

    .btn.primary{
      border-color: rgba(252,206,146,.55);
      background: linear-gradient(135deg, rgba(252,206,146,.92), rgba(195,156,115,.86));
      color: #221c12;
      font-weight: 900;
    }
    .btn.secondary{
      border-color: rgba(127,142,139,.35);
      background: linear-gradient(135deg, rgba(127,142,139,.18), rgba(174,175,161,.14));
    }
    .btn.danger{
      border-color: rgba(104,78,45,.42);
      background: rgba(104,78,45,.12);
    }

    /* ---------- Tabs ---------- */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      border:1px solid var(--line);
      background: rgba(21,22,16,.50);
      padding: 8px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      margin: 12px 0 16px;
      position: sticky;
      top: 10px;
      z-index: 5;
      backdrop-filter: blur(10px);
    }
    [data-theme="light"] .tabs{ background: rgba(255,255,255,.84); }
    @supports not (backdrop-filter: blur(10px)){
      .tabs{ background: var(--card); }
    }
    .tab{
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 13px;
      transition: .15s;
      min-height: 44px;
    }
    .tab[aria-selected="true"]{
      background: var(--card);
      color: var(--text);
      border-color: var(--line);
      box-shadow: var(--shadow);
    }

    /* ---------- Layout ---------- */
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .toolbar{ justify-content:flex-start; }
    }

    /* ---------- Cards ---------- */
    .card{
      border: 1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(21,22,16,.86), rgba(17,18,13,.84));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    [data-theme="light"] .card{
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92));
    }
    .card h2{
      margin:0 0 12px;
      font-size: 16px;
      letter-spacing: -.2px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 640px){
      .row{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input[type="text"], input[type="date"], input[type="number"], textarea, select{
      width:100%;
      border: 1px solid var(--line);
      background: rgba(21,22,16,.60);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 14px;
      outline:none;
      font-size: var(--fs-input);
      line-height: 1.7;
    }
    [data-theme="light"] input[type="text"],
    [data-theme="light"] input[type="date"],
    [data-theme="light"] input[type="number"],
    [data-theme="light"] textarea,
    [data-theme="light"] select{
      background: rgba(255,255,255,.92);
    }

    textarea{ min-height: 96px; resize: vertical; }

    @media (max-width: 640px){
      :root{ --fs-input: 16px; } /* 모바일 자동 확대 방지 */
      textarea{ min-height: 120px; }
    }

    ::placeholder{ color: rgba(198,192,180,.72); }
    [data-theme="light"] ::placeholder{ color: rgba(92,85,73,.62); }

    input:focus, textarea:focus, select:focus{
      box-shadow: var(--focus);
      border-color: rgba(252,206,146,.55);
    }
    :focus-visible{
      outline: none;
      box-shadow: var(--focus);
    }

    .divider{ height:1px; background: var(--line); margin: 14px 0; }
    .hint{ font-size: 12px; color: var(--muted); margin-top: 10px; }

    /* ---------- KPI ---------- */
    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media (max-width: 640px){
      .kpi{ grid-template-columns: 1fr; }
    }
    .mini{
      border:1px solid var(--line);
      background: rgba(21,22,16,.52);
      border-radius: 16px;
      padding: 12px;
    }
    [data-theme="light"] .mini{ background: rgba(255,255,255,.90); }
    .mini .v{ font-size: 18px; font-weight: 900; letter-spacing: -.3px; }
    .mini .k{ font-size: 12px; color: var(--muted); margin-top: 4px; }

    /* ---------- KOUM ---------- */
    .koum{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 900px){
      .koum{ grid-template-columns: 1fr; }
    }

    .step{
      position: relative;
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 14px;
      background: rgba(21,22,16,.48);
      overflow: hidden;
    }
    [data-theme="light"] .step{ background: rgba(255,255,255,.90); }

    /* Left accent bar per step — photo palette harmony */
    .step::before{
      content:"";
      position:absolute;
      left:0;
      top:12px;
      bottom:12px;
      width: 4px;
      border-radius: 99px;
      opacity: .98;
      background: var(--brand);
    }
    .step[data-key="K"]::before{ background: var(--p-slate); } /* 차분한 시작 */
    .step[data-key="O"]::before{ background: var(--p-sage); }  /* 관찰 톤 */
    .step[data-key="U"]::before{ background: var(--p-sand); }  /* 교정/빛 */
    .step[data-key="M"]::before{ background: var(--p-olive); } /* 실행/뿌리 */

    /* Soft glow like sunset */
    .step::after{
      content:"";
      position:absolute;
      left:-25%;
      right:-25%;
      top:-70px;
      height: 140px;
      background: radial-gradient(closest-side, rgba(252,206,146,.18), transparent 65%);
      pointer-events:none;
    }

    .stepHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .stepTitle{
      display:flex;
      align-items:flex-start;
      gap: 10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 34px;
      height: 34px;
      border-radius: 12px;
      font-weight: 900;
      color: #221c12;
      border: 1px solid rgba(252,206,146,.40);
      background: linear-gradient(135deg, rgba(252,206,146,.92), rgba(195,156,115,.84));
      flex: 0 0 auto;
      margin-top: 1px;
    }

    /* Step-specific pill tint */
    .step[data-key="K"] .pill{
      border-color: rgba(127,142,139,.40);
      background: linear-gradient(135deg, rgba(127,142,139,.78), rgba(174,175,161,.55));
      color: #0e0f0c;
    }
    .step[data-key="O"] .pill{
      border-color: rgba(174,175,161,.40);
      background: linear-gradient(135deg, rgba(174,175,161,.78), rgba(195,156,115,.40));
      color: #0e0f0c;
    }
    .step[data-key="U"] .pill{
      border-color: rgba(252,206,146,.45);
      background: linear-gradient(135deg, rgba(252,206,146,.92), rgba(195,156,115,.80));
      color: #221c12;
    }
    .step[data-key="M"] .pill{
      border-color: rgba(88,74,27,.55);
      background: linear-gradient(135deg, rgba(88,74,27,.92), rgba(104,78,45,.80));
      color: #fbf8f2;
    }

    .stepTitle b{
      display:block;
      font-size: 15px;
      letter-spacing: -.2px;
    }
    .stepTitle span{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .q{
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    .koum textarea{ min-height: 96px; }

    /* ---------- History ---------- */
    .list{ display:flex; flex-direction:column; gap:10px; }
    .entry{
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      background: rgba(21,22,16,.48);
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    [data-theme="light"] .entry{ background: rgba(255,255,255,.90); }
    .entry .meta{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .entry .meta .t{ font-size: 13px; font-weight: 900; letter-spacing: -.2px; }
    .entry .meta .s{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 680px;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(21,22,16,.40);
      color: var(--muted);
      font-size: 12px;
    }
    [data-theme="light"] .chip{ background: rgba(251,248,242,.88); }
    .chip b{ color: var(--text); }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .searchRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .searchRow input{ flex:1; min-width:220px; }

    @media (max-width: 640px){
      .entry{ flex-direction: column; gap: 10px; }
      .entry .meta .s{ white-space: normal; max-width: 100%; }
      .actions{ justify-content:flex-start; }
    }

    /* ---------- Modal / Toast ---------- */
    dialog{
      border:1px solid var(--line);
      border-radius: 18px;
      background: var(--card);
      color: var(--text);
      width: min(720px, calc(100% - 24px));
      box-shadow: var(--shadow);
      padding: 0;
    }
    dialog::backdrop{ background: rgba(0,0,0,.55); }
    .modalHead{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modalHead b{ font-size: 14px; }
    .modalBody{ padding: 14px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .toast{
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(21,22,16,.92);
      border: 1px solid rgba(252,206,146,.30);
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      font-size: 13px;
      color: var(--text);
      display:none;
      z-index: 9999;
    }
    [data-theme="light"] .toast{ background: rgba(255,255,255,.94); }
    .toast.show{ display:block; }

    /* ---------- Desktop/Mobile visibility helpers ---------- */
    .only-desktop{ display: inline-flex; }
    .only-mobile{ display: none; }

    /* ---------- Mobile: bottom action bar for Save/Copy/Share ---------- */
    @media (max-width: 640px){
      .top{
        flex-direction: column;
        gap: 10px;
        margin-bottom: 18px;
      }
      .only-desktop{ display:none; }
      .only-mobile{ display:inline-flex; }

      .toolbar{
        position: fixed;
        left: 10px;
        right: 10px;
        bottom: 10px;
        z-index: 9998;

        background: rgba(21,22,16,.94);
        border: 1px solid rgba(252,206,146,.18);
        border-radius: 18px;
        padding: 10px;

        box-shadow: var(--shadow);
        justify-content: space-between;
        gap: 8px;
      }
      [data-theme="light"] .toolbar{
        background: rgba(255,255,255,.96);
      }
      .toolbar .btn{
        flex: 1;
        justify-content: center;
        border-radius: 14px;
      }

      /* content not hidden behind bar */
      .wrap{ padding-bottom: 126px; }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior: auto !important; }
      .btn{ transition:none !important; }
      .btn:hover{ transform:none !important; }
    }
  </style>
</head>

<body>
  <div class="wrap" id="app">
    <div class="top">
      <div class="brandBlock">
        <h1>COACHERO 크루원 · 일일 기록</h1>
        <div class="subtitle">KOUM 4단계 기반 점검/성찰/실행 기록 — 카톡 공유·텍스트 복사 중심 (Earth Palette)</div>
        <div class="badge" id="versionBadge">
          <span>템플릿</span> <b>v1.2</b> <span class="tiny">· KOUM · local-only</span>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn primary" id="saveBtn" title="오늘 기록 저장">저장</button>
        <button class="btn secondary" id="copyTodayBtn" title="오늘 요약 텍스트 복사">오늘요약 복사</button>
        <button class="btn secondary" id="shareTodayBtn" title="카톡 공유(공유 시트) / 미지원 시 복사">카톡 공유</button>

        <button class="btn only-desktop" id="exportBtn" title="JSON/CSV 내보내기">백업</button>
        <button class="btn only-desktop" id="importBtn" title="JSON 가져오기">복원</button>
        <button class="btn ghost only-desktop" id="themeBtn" title="테마 전환">테마</button>

        <button class="btn only-mobile" id="moreBtn" title="백업/복원/테마">더보기</button>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="페이지 탭">
      <button class="tab" role="tab" aria-selected="true" data-tab="today">오늘 기록</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="history">히스토리</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="settings">설정</button>
    </div>

    <!-- TODAY -->
    <section id="tab-today">
      <div class="grid">
        <div class="card">
          <h2>기본 체크인</h2>

          <div class="row">
            <div>
              <label>날짜</label>
              <input type="date" id="date" />
            </div>
            <div>
              <label>크루원 이름/닉네임</label>
              <input type="text" id="name" placeholder="예: 김철웅 / COACHERO-01" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>에너지 (0~10)</label>
              <input type="number" id="energy" min="0" max="10" step="1" placeholder="0~10" />
            </div>
            <div>
              <label>기분 (0~10)</label>
              <input type="number" id="mood" min="0" max="10" step="1" placeholder="0~10" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div>
              <label>오늘의 한 줄 목적(의도)</label>
              <input type="text" id="intent" placeholder="예: 오늘은 '침착하게' 결정한다." />
            </div>
            <div>
              <label>오늘의 키워드(쉼표로 구분)</label>
              <input type="text" id="tags" placeholder="예: 집중, 기도, 실행" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>오늘의 승리/감사 1~3개</label>
              <textarea id="wins" placeholder="• ..." ></textarea>
            </div>
            <div>
              <label>오늘의 장애/유혹/과제</label>
              <textarea id="challenges" placeholder="• ..." ></textarea>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>말씀/기도/통찰 (오늘 붙잡은 한 구절 또는 메시지)</label>
              <textarea id="word" placeholder="예: (구절) / (요약) / (깨달음)"></textarea>
            </div>
            <div>
              <label>내일을 위한 한 가지 행동(측정 가능)</label>
              <textarea id="nextAction" placeholder="예: 09:00~09:30, 폰 비행기모드, '보고서 1페이지' 작성"></textarea>
            </div>
          </div>

          <div class="hint">
            입력 중 내용은 자동으로 임시저장됩니다(이 기기/브라우저 로컬). “저장”을 눌러야 히스토리에 기록됩니다.
          </div>
        </div>

        <div class="card">
          <h2>오늘의 대시보드</h2>
          <div class="kpi">
            <div class="mini">
              <div class="v" id="kpiEntries">0</div>
              <div class="k">누적 기록(건)</div>
            </div>
            <div class="mini">
              <div class="v" id="kpiStreak">0</div>
              <div class="k">연속 기록(일)</div>
            </div>
            <div class="mini">
              <div class="v" id="kpiLast">-</div>
              <div class="k">최근 기록</div>
            </div>
          </div>

          <div class="divider"></div>

          <h2>KOUM 4단계 기록</h2>
          <div class="koum" id="koumGrid"></div>

          <div class="divider"></div>

          <div class="row">
            <div>
              <label>오늘의 자기평가(0~10) — “주도성/성실성/평안” 종합</label>
              <input type="number" id="score" min="0" max="10" step="1" placeholder="0~10" />
            </div>
            <div>
              <label>마무리 한 줄(오늘의 결론/선포)</label>
              <input type="text" id="closing" placeholder="예: 나는 오늘 '한 걸음'을 선택했다." />
            </div>
          </div>

          <div class="hint">
            카톡 공유는 “공유 시트(Web Share)”를 사용합니다. 브라우저가 미지원이면 자동으로 텍스트를 복사합니다.
          </div>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="tab-history" style="display:none">
      <div class="card">
        <h2>히스토리</h2>
        <div class="searchRow">
          <input type="text" id="search" placeholder="검색: 날짜, 키워드, KOUM 내용, 승리/과제 등" />
          <select id="sort">
            <option value="desc">최신순</option>
            <option value="asc">오래된순</option>
          </select>
          <button class="btn small" id="clearSearch">검색 초기화</button>
        </div>
        <div class="divider"></div>
        <div class="list" id="historyList"></div>
        <div class="hint" id="historyHint"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" style="display:none">
      <div class="grid">
        <div class="card">
          <h2>KOUM 단계 이름/설명(커스터마이즈)</h2>

          <div class="row">
            <div>
              <label>K 단계 이름</label>
              <input type="text" id="kName" />
            </div>
            <div>
              <label>K 단계 설명(짧게)</label>
              <input type="text" id="kDesc" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>O 단계 이름</label>
              <input type="text" id="oName" />
            </div>
            <div>
              <label>O 단계 설명(짧게)</label>
              <input type="text" id="oDesc" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>U 단계 이름</label>
              <input type="text" id="uName" />
            </div>
            <div>
              <label>U 단계 설명(짧게)</label>
              <input type="text" id="uDesc" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>M 단계 이름</label>
              <input type="text" id="mName" />
            </div>
            <div>
              <label>M 단계 설명(짧게)</label>
              <input type="text" id="mDesc" />
            </div>
          </div>

          <div class="divider"></div>

          <h2>기본값</h2>
          <div class="row">
            <div>
              <label>기본 이름(자동 입력)</label>
              <input type="text" id="defaultName" placeholder="예: COACHERO-크루" />
            </div>
            <div>
              <label>자동 저장 간격(초)</label>
              <input type="number" id="autosaveSec" min="3" max="60" step="1" />
            </div>
          </div>

          <div class="divider"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="saveSettingsBtn">설정 저장</button>
            <button class="btn" id="resetDraftBtn">오늘 초안 초기화</button>
            <button class="btn danger" id="wipeAllBtn">전체 데이터 삭제</button>
          </div>

          <div class="hint">
            “전체 데이터 삭제”는 이 기기/브라우저에 저장된 모든 기록을 삭제합니다. 복구가 어렵습니다.
          </div>
        </div>

        <div class="card">
          <h2>백업/복원 안내</h2>
          <div class="hint" style="margin-top:0">
            데이터는 서버로 전송되지 않습니다(로컬 저장). 다른 기기로 옮기려면 “백업(JSON)” 후 “복원”을 사용하세요.
          </div>
          <div class="divider"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" id="exportBtn2">백업(JSON/CSV)</button>
            <button class="btn" id="importBtn2">복원(JSON)</button>
            <button class="btn ghost" id="themeBtn2">테마 전환</button>
          </div>

          <div class="divider"></div>

          <div class="tiny mono">
            팁: 모바일에서는 하단 액션바(저장/복사/카톡공유)를 주로 사용하고,
            백업/복원/테마는 “더보기” 또는 이 설정 탭에서 수행하세요.
          </div>
        </div>
      </div>
    </section>

    <div class="toast" id="toast"></div>

    <dialog id="modal">
      <div class="modalHead">
        <b id="modalTitle">옵션</b>
        <button class="btn small" id="closeModal">닫기</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </dialog>

    <input type="file" id="fileInput" accept="application/json" style="display:none" />
  </div>

  <script>
    /***********************
     * COACHERO Daily Log
     * Single-file HTML
     * v1.2 (Earth Palette)
     ***********************/

    const APP_VERSION = "v1.2";
    const SCHEMA_VERSION = 1;

    const STORAGE_KEYS = {
      settings: "coachero_daily_settings_v1",
      draft: "coachero_daily_draft_v1",
      entries: "coachero_daily_entries_v1",
      theme: "coachero_daily_theme_v1"
    };

    const DEFAULT_SETTINGS = {
      schemaVersion: SCHEMA_VERSION,
      defaultName: "",
      autosaveSec: 8,
      koum: {
        K: { name: "K — Key Focus", desc: "오늘의 중심(지휘봉)을 주님께", prompts: [
          "오늘 내 생각의 전쟁터는 ________에서 시작된다.",
          "오늘 내가 주님께 드릴 지휘봉(중심)은 ________이다.",
          "오늘의 한 줄 목적(의도)은 “나는 ________한다”이다."
        ]},
        O: { name: "O — Observe", desc: "자동생각/입력/패턴 관찰", prompts: [
          "오늘 자동으로 떠오른 첫 문장은 “________”였다.",
          "오늘 나를 흔든 입력(보고/듣고/비교한 것)은 ________이었다.",
          "오늘 가장 강했던 패턴은 (불안/산만/분노/쾌락/절망) 중 ________이다."
        ]},
        U: { name: "U — Upgrade", desc: "하늘 필터·말씀 선포로 교정", prompts: [
          "세상 필터는 “________”라고 말했지만, 하늘 필터는 “________”라고 말한다.",
          "내 안의 거짓은 “________”이고, 오늘의 선포는 “________”이다.",
          "하나님 관점에서 이 사건의 의미는 ________이다."
        ]},
        M: { name: "M — Move", desc: "작게·측정 가능하게 순종", prompts: [
          "오늘의 작은 순종 1개는 ________이다.",
          "실행은 (언제) ________ / (어디서) ________ / (완료 기준) ________이다.",
          "하루의 첫 입력을 나는 ________로 선택한다."
        ]}
      }
    };

    const $ = (id) => document.getElementById(id);

    const els = {
      tabs: Array.from(document.querySelectorAll(".tab")),
      sections: {
        today: $("tab-today"),
        history: $("tab-history"),
        settings: $("tab-settings")
      },
      toast: $("toast"),
      modal: $("modal"),
      modalTitle: $("modalTitle"),
      modalBody: $("modalBody"),
      fileInput: $("fileInput"),
      versionBadge: $("versionBadge"),
      historyList: $("historyList"),
      historyHint: $("historyHint"),
      search: $("search"),
      sort: $("sort")
    };

    const formIds = [
      "date","name","energy","mood","intent","tags","wins","challenges","word","nextAction",
      "score","closing"
    ];

    const koumKeys = ["K","O","U","M"];
    const koumFieldsPerStep = ["title","body","prayer","action"];
    const koumInputs = {};

    function nowISO(){ return new Date().toISOString(); }
    function todayISODate(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function safeParse(json, fallback){
      try{ return JSON.parse(json); } catch(e){ return fallback; }
    }
    function uuid(){
      if (typeof crypto !== "undefined" && crypto.randomUUID) return crypto.randomUUID();
      return "id-" + Date.now().toString(16) + "-" + Math.random().toString(16).slice(2);
    }
    function splitTags(s){
      return String(s||"").split(",").map(x => x.trim()).filter(Boolean);
    }
    function toNumOrNull(v){
      if (v === "" || v == null) return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    function clamp010Value(v){
      const n = Number(v);
      if (!Number.isFinite(n)) return v;
      return String(Math.max(0, Math.min(10, Math.round(n))));
    }

    function toast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> els.toast.classList.remove("show"), 1600);
    }

    function getTheme(){
      const t = localStorage.getItem(STORAGE_KEYS.theme);
      return t === "light" ? "light" : "dark";
    }
    function setTheme(t){
      localStorage.setItem(STORAGE_KEYS.theme, t);
      document.documentElement.setAttribute("data-theme", t);
    }

    function loadSettings(){
      const raw = localStorage.getItem(STORAGE_KEYS.settings);
      const s = raw ? safeParse(raw, DEFAULT_SETTINGS) : DEFAULT_SETTINGS;
      return migrateSettings(s);
    }
    function saveSettings(s){
      localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(s));
    }
    function migrateSettings(s){
      if (!s || typeof s !== "object") return structuredClone(DEFAULT_SETTINGS);
      if (!("schemaVersion" in s)) s.schemaVersion = SCHEMA_VERSION;

      s.koum ||= structuredClone(DEFAULT_SETTINGS.koum);
      for (const k of koumKeys){
        s.koum[k] ||= structuredClone(DEFAULT_SETTINGS.koum[k]);
        s.koum[k].name ||= DEFAULT_SETTINGS.koum[k].name;
        s.koum[k].desc ||= DEFAULT_SETTINGS.koum[k].desc;
        s.koum[k].prompts ||= structuredClone(DEFAULT_SETTINGS.koum[k].prompts);
      }
      if (typeof s.autosaveSec !== "number") s.autosaveSec = DEFAULT_SETTINGS.autosaveSec;
      if (typeof s.defaultName !== "string") s.defaultName = DEFAULT_SETTINGS.defaultName;
      return s;
    }

    function loadEntries(){
      const raw = localStorage.getItem(STORAGE_KEYS.entries);
      const arr = raw ? safeParse(raw, []) : [];
      return Array.isArray(arr) ? arr.map(migrateEntry).filter(Boolean) : [];
    }
    function saveEntries(entries){
      localStorage.setItem(STORAGE_KEYS.entries, JSON.stringify(entries));
    }
    function migrateEntry(e){
      if (!e || typeof e !== "object") return null;
      e.schemaVersion ||= 1;
      e.id ||= uuid();
      e.date ||= todayISODate();
      e.createdAt ||= nowISO();
      e.updatedAt ||= nowISO();
      e.tags = Array.isArray(e.tags) ? e.tags : (typeof e.tags === "string" ? splitTags(e.tags) : []);
      e.koum ||= {};
      for (const k of koumKeys){
        e.koum[k] ||= {};
        for (const f of koumFieldsPerStep){
          if (typeof e.koum[k][f] !== "string") e.koum[k][f] = "";
        }
      }
      return e;
    }

    function getDraft(){
      const raw = localStorage.getItem(STORAGE_KEYS.draft);
      const d = raw ? safeParse(raw, null) : null;
      return d && typeof d === "object" ? d : null;
    }
    function setDraft(obj){
      localStorage.setItem(STORAGE_KEYS.draft, JSON.stringify(obj));
    }
    function clearDraft(){
      localStorage.removeItem(STORAGE_KEYS.draft);
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function showPrompts(key, settings){
      els.modalTitle.textContent = `${key} 단계 프롬프트(문장완성)`;
      const p = settings.koum[key].prompts || [];
      els.modalBody.innerHTML = `
        <div style="font-size:13px; color:var(--muted); margin-bottom:10px">
          아래 문장을 그대로 이어서 완성하세요. 길게 설명하지 말고 “첫 문장”으로 적습니다.
        </div>
        <ol style="margin:0; padding-left:18px; color:var(--text)">
          ${p.map(x => `<li style="margin:8px 0">${escapeHtml(x)} <span style="color:var(--muted)">→</span> ________</li>`).join("")}
        </ol>
      `;
      els.modal.showModal();
    }

    function buildKoumUI(settings){
      const grid = $("koumGrid");
      grid.innerHTML = "";

      for (const key of koumKeys){
        const step = document.createElement("div");
        step.className = "step";
        step.dataset.key = key;

        const head = document.createElement("div");
        head.className = "stepHead";

        const title = document.createElement("div");
        title.className = "stepTitle";

        const pill = document.createElement("div");
        pill.className = "pill";
        pill.textContent = key;

        const textWrap = document.createElement("div");
        const b = document.createElement("b");
        b.textContent = settings.koum[key].name;

        const span = document.createElement("span");
        span.textContent = settings.koum[key].desc;

        textWrap.appendChild(b);
        textWrap.appendChild(span);

        title.appendChild(pill);
        title.appendChild(textWrap);

        const promptBtn = document.createElement("button");
        promptBtn.className = "btn small";
        promptBtn.type = "button";
        promptBtn.textContent = "프롬프트";
        promptBtn.addEventListener("click", ()=> showPrompts(key, settings));

        head.appendChild(title);
        head.appendChild(promptBtn);
        step.appendChild(head);

        const fields = [
          { key:"title", label:"한 줄 요약(문장완성)", placeholder:"예: 오늘 내 생각의 지휘봉(중심)은 ________이다." },
          { key:"body", label:"핵심 내용", placeholder:"• ..." },
          { key:"prayer", label:"기도/선포(선택)", placeholder:"예: 주님, ________ 하게 하소서." },
          { key:"action", label:"행동(측정 가능)", placeholder:"예: 20분 타이머, ________ 1개 완료" }
        ];

        for (const f of fields){
          const q = document.createElement("div");
          q.className = "q";
          q.textContent = f.label;

          const ta = document.createElement("textarea");
          ta.id = `koum_${key}_${f.key}`;
          ta.placeholder = f.placeholder;

          step.appendChild(q);
          step.appendChild(ta);

          koumInputs[key] ||= {};
          koumInputs[key][f.key] = ta;
        }

        grid.appendChild(step);
      }
    }

    function collectForm(){
      const data = {};
      for (const id of formIds){
        const el = $(id);
        data[id] = el ? el.value : "";
      }
      data.tags = splitTags(data.tags);
      data.energy = toNumOrNull(data.energy);
      data.mood = toNumOrNull(data.mood);
      data.score = toNumOrNull(data.score);

      data.koum = {};
      for (const k of koumKeys){
        data.koum[k] = {};
        for (const f of koumFieldsPerStep){
          data.koum[k][f] = (koumInputs[k]?.[f]?.value ?? "");
        }
      }
      return data;
    }

    function fillForm(data){
      if (!data) return;
      for (const id of formIds){
        const el = $(id);
        if (!el) continue;
        if (id === "tags"){
          el.value = Array.isArray(data.tags) ? data.tags.join(", ") : (data.tags || "");
        } else {
          el.value = data[id] ?? "";
        }
      }
      if (data.koum){
        for (const k of koumKeys){
          for (const f of koumFieldsPerStep){
            if (koumInputs[k]?.[f]) koumInputs[k][f].value = data.koum?.[k]?.[f] ?? "";
          }
        }
      }
    }

    function makeEntryFromForm(existingId=null, createdAt=null){
      const f = collectForm();
      const entry = {
        schemaVersion: SCHEMA_VERSION,
        id: existingId || uuid(),
        date: f.date || todayISODate(),
        createdAt: createdAt || nowISO(),
        updatedAt: nowISO(),
        name: f.name || "",
        energy: f.energy,
        mood: f.mood,
        intent: f.intent || "",
        tags: f.tags || [],
        wins: f.wins || "",
        challenges: f.challenges || "",
        word: f.word || "",
        nextAction: f.nextAction || "",
        koum: f.koum || {},
        score: f.score,
        closing: f.closing || ""
      };
      return migrateEntry(entry);
    }

    function validateMinimal(entry){
      if (!entry.date) return "날짜가 필요합니다.";
      return null;
    }

    function computeStreak(entries){
      const dates = Array.from(new Set(entries.map(e=>e.date))).sort();
      if (!dates.length) return 0;
      const last = dates[dates.length - 1];
      let streak = 1;
      let cursor = new Date(last + "T00:00:00");
      for (let i = dates.length - 2; i >= 0; i--){
        const d = new Date(dates[i] + "T00:00:00");
        const prev = new Date(cursor);
        prev.setDate(prev.getDate() - 1);
        if (d.getFullYear()===prev.getFullYear() && d.getMonth()===prev.getMonth() && d.getDate()===prev.getDate()){
          streak++;
          cursor = d;
        } else if (d < prev){
          break;
        }
      }
      return streak;
    }

    function updateKPIs(entries){
      $("kpiEntries").textContent = entries.length;
      $("kpiStreak").textContent = computeStreak(entries);
      const last = entries.slice().sort((a,b)=> a.date.localeCompare(b.date)).slice(-1)[0];
      $("kpiLast").textContent = last ? last.date : "-";
    }

    function buildSnippet(e, settings){
      const kShort = settings.koum.K.name.split("—")[0].trim();
      const line = (e.koum?.K?.title || e.intent || e.closing || "").trim();
      const a = (e.koum?.M?.action || e.nextAction || "").trim();
      return `${kShort}: ${line || "—"} / 실행: ${a || "—"}`;
    }

    function renderHistory(entries, settings){
      const q = (els.search.value || "").trim().toLowerCase();
      const sort = els.sort.value;
      const list = els.historyList;
      list.innerHTML = "";

      let items = entries.slice();

      if (q){
        items = items.filter(e=>{
          const blob = [
            e.date, e.name, e.intent, (e.tags||[]).join(","),
            e.wins, e.challenges, e.word, e.nextAction, e.closing,
            ...koumKeys.flatMap(k => koumFieldsPerStep.map(f => e.koum?.[k]?.[f] || ""))
          ].join("\n").toLowerCase();
          return blob.includes(q);
        });
      }

      items.sort((a,b)=> sort === "asc"
        ? a.date.localeCompare(b.date)
        : b.date.localeCompare(a.date)
      );

      if (!items.length){
        els.historyHint.textContent = q ? "검색 결과가 없습니다." : "아직 저장된 기록이 없습니다. ‘오늘 기록’에서 작성 후 저장하세요.";
        return;
      }
      els.historyHint.textContent = "";

      for (const e of items){
        const topLine = `${e.date} · ${e.name || "이름 미입력"}`;
        const snippet = buildSnippet(e, settings);

        const row = document.createElement("div");
        row.className = "entry";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <div class="t">${escapeHtml(topLine)}</div>
          <div class="s">${escapeHtml(snippet)}</div>
          <div class="chips">
            ${(e.tags||[]).slice(0,6).map(t=>`<span class="chip">#${escapeHtml(t)}</span>`).join("")}
            ${((e.energy!=null)||(e.mood!=null)) ? `<span class="chip"><b>에너지</b> ${e.energy??"-"} · <b>기분</b> ${e.mood??"-"}</span>` : ""}
            ${(e.score!=null) ? `<span class="chip"><b>점수</b> ${e.score}</span>` : ""}
          </div>
        `;

        const actions = document.createElement("div");
        actions.className = "actions";

        const openBtn = document.createElement("button");
        openBtn.className = "btn small";
        openBtn.textContent = "열기/편집";
        openBtn.addEventListener("click", ()=> openEntry(e.id));

        const copyBtn = document.createElement("button");
        copyBtn.className = "btn small secondary";
        copyBtn.textContent = "요약 복사";
        copyBtn.addEventListener("click", ()=> copySummary(e, settings));

        const delBtn = document.createElement("button");
        delBtn.className = "btn small danger";
        delBtn.textContent = "삭제";
        delBtn.addEventListener("click", ()=> deleteEntry(e.id));

        actions.appendChild(openBtn);
        actions.appendChild(copyBtn);
        actions.appendChild(delBtn);

        row.appendChild(meta);
        row.appendChild(actions);
        list.appendChild(row);
      }
    }

    function openEntry(id){
      const entries = loadEntries();
      const e = entries.find(x=>x.id===id);
      if (!e){ toast("기록을 찾지 못했습니다."); return; }

      selectTab("today");
      fillForm({
        date: e.date,
        name: e.name,
        energy: e.energy ?? "",
        mood: e.mood ?? "",
        intent: e.intent ?? "",
        tags: e.tags ?? [],
        wins: e.wins ?? "",
        challenges: e.challenges ?? "",
        word: e.word ?? "",
        nextAction: e.nextAction ?? "",
        koum: e.koum ?? {},
        score: e.score ?? "",
        closing: e.closing ?? ""
      });

      window.__editing = { id: e.id, createdAt: e.createdAt };
      toast("편집 모드: 저장 시 기존 기록이 업데이트됩니다.");
    }

    function deleteEntry(id){
      if (!confirm("이 기록을 삭제할까요? (복구 어려움)")) return;
      let entries = loadEntries();
      entries = entries.filter(e=>e.id !== id);
      saveEntries(entries);
      updateKPIs(entries);
      renderHistory(entries, loadSettings());
      toast("삭제했습니다.");
    }

    function compactOneLine(s){
      s = String(s||"").trim();
      if (!s) return "-";
      return s.replace(/\s+/g," ").slice(0, 160);
    }

    function buildShareText(e, settings){
      const lines = [];
      lines.push(`COACHERO 일일기록 (${e.date})${e.name ? " — " + e.name : ""}`);
      lines.push(`의도: ${e.intent || "-"}`);
      lines.push(`승리/감사: ${compactOneLine(e.wins)}`);
      lines.push(`과제/유혹: ${compactOneLine(e.challenges)}`);

      for (const k of koumKeys){
        const n = settings.koum[k].name;
        const t = compactOneLine(e.koum?.[k]?.title);
        const m = compactOneLine(e.koum?.[k]?.action);
        lines.push(`${n}: ${t}`);
        if (m !== "-") lines.push(`- 실행: ${m}`);
      }

      lines.push(`말씀/통찰: ${compactOneLine(e.word)}`);
      lines.push(`한 줄 선포: ${e.closing || "-"}`);
      lines.push(`내일 행동: ${compactOneLine(e.nextAction)}`);
      lines.push(`키워드: ${(e.tags||[]).map(t=>"#"+t).join(" ") || "-"}`);
      return lines.join("\n");
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        toast("텍스트를 복사했습니다.");
      }catch(err){
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); toast("텍스트를 복사했습니다."); }
        catch(e){ alert("복사 실패: 브라우저 권한을 확인하세요."); }
        finally{ ta.remove(); }
      }
    }

    async function copySummary(e, settings){
      const text = buildShareText(e, settings);
      await copyText(text);
    }

    async function shareToKakaoOrCopy(text){
      if (navigator.share){
        try{
          await navigator.share({ text });
          toast("공유 시트를 열었습니다.");
          return;
        }catch(e){
          if (String(e?.name||"").toLowerCase().includes("abort")) return;
        }
      }
      await copyText(text);
      toast("공유 미지원: 텍스트를 복사했습니다.");
    }

    function selectTab(tab){
      els.tabs.forEach(b=>{
        const is = b.dataset.tab === tab;
        b.setAttribute("aria-selected", is ? "true":"false");
      });
      for (const k of Object.keys(els.sections)){
        els.sections[k].style.display = (k === tab) ? "" : "none";
      }
    }

    function openExport(entries, settings){
      els.modalTitle.textContent = "백업(내보내기)";
      const json = JSON.stringify({ appVersion: APP_VERSION, schemaVersion: SCHEMA_VERSION, exportedAt: nowISO(), entries }, null, 2);

      els.modalBody.innerHTML = `
        <div class="row">
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn small" id="downloadJson">JSON 다운로드</button>
            <button class="btn small" id="downloadCsv">CSV 다운로드</button>
            <button class="btn small" id="copyJson">JSON 복사</button>
          </div>
          <div class="tiny" style="margin-top:6px">
            권장: JSON(전체 구조 보존). CSV는 핵심 필드만 1행으로 평탄화합니다.
          </div>
        </div>
        <div class="divider"></div>
        <textarea class="mono" style="min-height:240px; width:100%">${escapeHtml(json)}</textarea>
      `;
      els.modal.showModal();

      setTimeout(()=>{
        $("downloadJson").onclick = ()=> downloadText(`coachero_daily_${todayISODate()}.json`, json, "application/json");
        $("downloadCsv").onclick = ()=> downloadText(`coachero_daily_${todayISODate()}.csv`, toCSV(entries, settings), "text/csv");
        $("copyJson").onclick = async ()=> { await copyText(json); };
      }, 0);
    }

    function toCSV(entries, settings){
      const header = [
        "date","name","energy","mood","intent","tags","wins","challenges","word","nextAction","score","closing",
        ...koumKeys.flatMap(k=>[
          `${k}_name`,`${k}_title`,`${k}_body`,`${k}_prayer`,`${k}_action`
        ])
      ];
      const rows = entries.map(e=>{
        const base = [
          e.date, e.name||"", e.energy??"", e.mood??"", e.intent||"", (e.tags||[]).join(" "),
          safeCell(e.wins), safeCell(e.challenges), safeCell(e.word), safeCell(e.nextAction), e.score??"", e.closing||""
        ];
        const koum = koumKeys.flatMap(k=>[
          settings.koum[k].name,
          safeCell(e.koum?.[k]?.title),
          safeCell(e.koum?.[k]?.body),
          safeCell(e.koum?.[k]?.prayer),
          safeCell(e.koum?.[k]?.action)
        ]);
        return [...base, ...koum];
      });
      return [header.join(","), ...rows.map(r=> r.map(csvEscape).join(","))].join("\n");
    }
    function safeCell(v){ return String(v||"").replace(/\r?\n/g, " / ").trim(); }
    function csvEscape(v){
      v = String(v??"");
      if (/[",\n]/.test(v)) return `"${v.replaceAll('"','""')}"`;
      return v;
    }
    function downloadText(filename, text, mime){
      const blob = new Blob([text], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("백업 파일을 생성했습니다.");
    }

    function openImport(){
      els.fileInput.value = "";
      els.fileInput.click();
    }

    function applyImportedData(payload){
      const entriesRaw = payload?.entries;
      if (!Array.isArray(entriesRaw)) throw new Error("entries 배열을 찾지 못했습니다.");
      const entries = entriesRaw.map(migrateEntry).filter(Boolean);
      saveEntries(entries);
      updateKPIs(entries);
      renderHistory(entries, loadSettings());
      toast(`복원 완료: ${entries.length}건`);
    }

    function autosaveTick(){
      const draft = collectForm();
      draft._meta = { savedAt: nowISO(), schemaVersion: SCHEMA_VERSION };
      setDraft(draft);
    }
    function installAutosave(settings){
      clearInterval(installAutosave._t);
      const sec = clampInt(settings.autosaveSec, 3, 60);
      installAutosave._t = setInterval(()=> autosaveTick(), sec * 1000);
    }
    function clampInt(n, min, max){
      n = Number(n);
      if (!Number.isFinite(n)) return min;
      return Math.max(min, Math.min(max, Math.round(n)));
    }

    function onSave(){
      const entries = loadEntries();
      const editing = window.__editing;

      const entry = editing
        ? makeEntryFromForm(editing.id, editing.createdAt)
        : makeEntryFromForm();

      const err = validateMinimal(entry);
      if (err){ alert(err); return; }

      let nextEntries;
      if (editing){
        nextEntries = entries.map(e => e.id === editing.id ? entry : e);
        window.__editing = null;
        toast("기존 기록을 업데이트했습니다.");
      } else {
        const dup = entries.find(e => e.date === entry.date && (e.name||"") === (entry.name||""));
        if (dup && !confirm("같은 날짜/이름 기록이 이미 있습니다. 새로 추가할까요?")){
          return;
        }
        nextEntries = [entry, ...entries];
        toast("오늘 기록을 저장했습니다.");
      }

      saveEntries(nextEntries);
      updateKPIs(nextEntries);
      renderHistory(nextEntries, loadSettings());

      const d = collectForm();
      d._meta = { savedAt: nowISO(), schemaVersion: SCHEMA_VERSION, lastCommitted: entry.id };
      setDraft(d);
    }

    function initSettingsUI(settings){
      $("kName").value = settings.koum.K.name;
      $("kDesc").value = settings.koum.K.desc;
      $("oName").value = settings.koum.O.name;
      $("oDesc").value = settings.koum.O.desc;
      $("uName").value = settings.koum.U.name;
      $("uDesc").value = settings.koum.U.desc;
      $("mName").value = settings.koum.M.name;
      $("mDesc").value = settings.koum.M.desc;

      $("defaultName").value = settings.defaultName || "";
      $("autosaveSec").value = settings.autosaveSec;
    }

    function initToday(settings, preferDraft=true){
      $("date").value = todayISODate();
      if (settings.defaultName && !$("name").value){
        $("name").value = settings.defaultName;
      }
      if (preferDraft){
        const draft = getDraft();
        if (draft){
          if (!draft.date) draft.date = todayISODate();
          fillForm(draft);
          toast("임시저장(초안)을 불러왔습니다.");
        }
      }
    }

    function bindEvents(){
      els.tabs.forEach(btn=>{
        btn.addEventListener("click", ()=> selectTab(btn.dataset.tab));
      });

      $("closeModal").addEventListener("click", ()=> els.modal.close());
      els.modal.addEventListener("click", (e)=>{
        const rect = els.modal.getBoundingClientRect();
        const inside = rect.top <= e.clientY && e.clientY <= rect.bottom && rect.left <= e.clientX && e.clientX <= rect.right;
        if (!inside) els.modal.close();
      });

      $("saveBtn").addEventListener("click", onSave);

      $("copyTodayBtn").addEventListener("click", async ()=>{
        const settings = loadSettings();
        const e = makeEntryFromForm(window.__editing?.id || null, window.__editing?.createdAt || null);
        await copySummary(e, settings);
      });

      $("shareTodayBtn").addEventListener("click", async ()=>{
        const settings = loadSettings();
        const e = makeEntryFromForm(window.__editing?.id || null, window.__editing?.createdAt || null);
        const text = buildShareText(e, settings);
        await shareToKakaoOrCopy(text);
      });

      $("exportBtn").addEventListener("click", ()=>{
        openExport(loadEntries(), loadSettings());
      });
      $("importBtn").addEventListener("click", openImport);
      $("themeBtn").addEventListener("click", ()=>{
        const t = getTheme() === "dark" ? "light" : "dark";
        setTheme(t);
        toast(`테마: ${t === "dark" ? "다크" : "라이트"}`);
      });

      $("exportBtn2").addEventListener("click", ()=>{
        openExport(loadEntries(), loadSettings());
      });
      $("importBtn2").addEventListener("click", openImport);
      $("themeBtn2").addEventListener("click", ()=>{
        const t = getTheme() === "dark" ? "light" : "dark";
        setTheme(t);
        toast(`테마: ${t === "dark" ? "다크" : "라이트"}`);
      });

      $("moreBtn").addEventListener("click", ()=>{
        els.modalTitle.textContent = "더보기";
        els.modalBody.innerHTML = `
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" id="mExport">백업</button>
            <button class="btn" id="mImport">복원</button>
            <button class="btn ghost" id="mTheme">테마</button>
          </div>
          <div class="divider"></div>
          <div class="tiny">
            공유/복사는 하단 바에서 진행합니다. 백업(JSON)을 정기적으로 권장합니다.
          </div>
        `;
        els.modal.showModal();
        setTimeout(()=>{
          $("mExport").onclick = ()=> { els.modal.close(); openExport(loadEntries(), loadSettings()); };
          $("mImport").onclick = ()=> { els.modal.close(); openImport(); };
          $("mTheme").onclick = ()=> {
            const t = getTheme() === "dark" ? "light" : "dark";
            setTheme(t);
            toast(`테마: ${t === "dark" ? "다크" : "라이트"}`);
          };
        }, 0);
      });

      const immediateSave = ()=>{
        const d = collectForm();
        d._meta = { savedAt: nowISO(), schemaVersion: SCHEMA_VERSION };
        setDraft(d);
      };
      for (const id of formIds){
        const el = $(id);
        if (!el) continue;
        el.addEventListener("input", immediateSave);
      }
      for (const k of koumKeys){
        for (const f of koumFieldsPerStep){
          const el = koumInputs[k]?.[f];
          if (el) el.addEventListener("input", immediateSave);
        }
      }

      ["energy","mood","score"].forEach(id=>{
        const el = $(id);
        if (!el) return;
        el.addEventListener("change", ()=>{ el.value = clamp010Value(el.value); });
      });

      els.search.addEventListener("input", ()=> renderHistory(loadEntries(), loadSettings()));
      els.sort.addEventListener("change", ()=> renderHistory(loadEntries(), loadSettings()));
      $("clearSearch").addEventListener("click", ()=>{
        els.search.value = "";
        renderHistory(loadEntries(), loadSettings());
      });

      els.fileInput.addEventListener("change", async ()=>{
        const file = els.fileInput.files?.[0];
        if (!file) return;
        try{
          const text = await file.text();
          const payload = safeParse(text, null);
          if (!payload) throw new Error("JSON 파싱 실패");
          applyImportedData(payload);
        }catch(err){
          alert("복원 실패: " + (err?.message || err));
        }
      });

      $("saveSettingsBtn").addEventListener("click", ()=>{
        const s = loadSettings();
        s.defaultName = $("defaultName").value || "";
        s.autosaveSec = clampInt($("autosaveSec").value, 3, 60);

        s.koum.K.name = $("kName").value || s.koum.K.name;
        s.koum.K.desc = $("kDesc").value || s.koum.K.desc;
        s.koum.O.name = $("oName").value || s.koum.O.name;
        s.koum.O.desc = $("oDesc").value || s.koum.O.desc;
        s.koum.U.name = $("uName").value || s.koum.U.name;
        s.koum.U.desc = $("uDesc").value || s.koum.U.desc;
        s.koum.M.name = $("mName").value || s.koum.M.name;
        s.koum.M.desc = $("mDesc").value || s.koum.M.desc;

        saveSettings(s);
        buildKoumUI(s);
        bindKoumImmediateSave();
        installAutosave(s);
        toast("설정을 저장했습니다.");
      });

      $("resetDraftBtn").addEventListener("click", ()=>{
        if (!confirm("오늘 초안(임시저장)을 초기화할까요?")) return;
        clearDraft();
        window.__editing = null;
        initToday(loadSettings(), false);
        toast("초안을 초기화했습니다.");
      });

      $("wipeAllBtn").addEventListener("click", ()=>{
        if (!confirm("전체 데이터(히스토리/설정/초안)를 삭제할까요? (복구 어려움)")) return;
        localStorage.removeItem(STORAGE_KEYS.entries);
        localStorage.removeItem(STORAGE_KEYS.settings);
        localStorage.removeItem(STORAGE_KEYS.draft);
        toast("전체 데이터를 삭제했습니다.");
        location.reload();
      });
    }

    function bindKoumImmediateSave(){
      const immediateSave = ()=>{
        const d = collectForm();
        d._meta = { savedAt: nowISO(), schemaVersion: SCHEMA_VERSION };
        setDraft(d);
      };
      for (const k of koumKeys){
        for (const f of koumFieldsPerStep){
          const el = koumInputs[k]?.[f];
          if (el) el.addEventListener("input", immediateSave);
        }
      }
    }

    function init(){
      els.versionBadge.querySelector("b").textContent = APP_VERSION;

      setTheme(getTheme());

      const settings = loadSettings();
      saveSettings(settings);

      buildKoumUI(settings);
      initSettingsUI(settings);

      const entries = loadEntries();
      saveEntries(entries);
      updateKPIs(entries);
      renderHistory(entries, settings);

      initToday(settings, true);

      bindEvents();
      bindKoumImmediateSave();
      installAutosave(settings);
    }

    init();
  </script>
</body>
</html>
